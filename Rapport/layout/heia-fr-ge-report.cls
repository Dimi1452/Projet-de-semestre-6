%% heia-fr-ge-report.cls
%% Copyright 2023 S. Kaempfer and M. Marguerat
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   https://www.latex-project.org/lppl.txt
% and version 1.3c or later is part of all distributions of LaTeX
% version 2008 or later.
%
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainers of this work are S. Kaempfer and M. Marguerat
% The Current Maintainers of this work are the School of Engineering and
% Architecture of Fribourg teaching staff
%
% This work consists of the file heia-fr-ge-report.cls.

% Layout file ==================================================================
\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{layout/heia-fr-ge-report}[07/07/2023 v1.0 Rapport HEIA]

%% Forward options to article --------------------------------------------------
\DeclareOption*{\PassOptionsToClass{\CurrentOption}{article}}
\ProcessOptions\relax

%% Setting up class ------------------------------------------------------------
%\LoadClass[11pt,twoside]{book} %% xx side book style, 11pt font
\LoadClass[11pt,oneside]{article} %% article, 11pt font

%% Basic definitions -----------------------------------------------------------
% Title Page ...................................................................
\def\subtitle#1{\gdef\@subtitle{#1}}
\def\subject#1{\gdef\@subject{#1}}
\def\typeDeTravail#1{\gdef\@typeDeTravail{#1}}
\def\Partenaire#1{\gdef\@Partenaire{#1}}
\def\Responsable#1{\gdef\@Responsable{#1}}

\def\responsableExterne#1{\gdef\@responsableExterne{#1}}
\def\filiere#1{\gdef\@filiere{#1}}
\def\dateDebut#1{\gdef\@dateDebut{#1}}
\def\dateFin#1{\gdef\@dateFin{#1}}

\def\TitlePic#1{\gdef\@TitlePic{#1}}
\def\TitlePicHight#1{\gdef\@TitlePicHight{#1}}
\def\DisFromTitleToPic#1{\gdef\@DisFromTitleToPic{#1}}

\def\copyrightNotice#1{\gdef\@copyrightNotice{#1}}
\def\Version#1{\gdef\@Version{#1}}

% Main pages ...................................................................
\def\TopLeft#1{\gdef\@TopLeft{#1}}
\def\TopRight#1{\gdef\@TopRight{#1}}
\def\BottomLeft#1{\gdef\@BottomLeft{#1}}
\def\BottomRight#1{\gdef\@BottomRight{#1}}

%% Main pakage -----------------------------------------------------------------
\RequirePackage[table]{xcolor}
\RequirePackage{babel}          % For autogenerated text in french (use "british" for english)
\RequirePackage{mathtools}      % Mathematical tools to use with amsmath
\RequirePackage{amssymb}        % Extended symbol collection
\RequirePackage{siunitx}        % SI units package
\RequirePackage{tabularx}       % Tabulars with adjustable-width columns
\RequirePackage{booktabs}       % Better quality tables
\RequirePackage{longtable}      % Allow tables to flow over page boundaries
\RequirePackage{multirow}       % Create tabular cells spanning multiple rows
\RequirePackage{graphicx}       % Enhanced support for images
\RequirePackage{float}          % Improved interface for floating objects
\RequirePackage[labelfont=bf,justification=centering,footnotesize]{caption} % Captions
\RequirePackage{subcaption}     % Support for sub-captions
\RequirePackage{pdfpages}       % Include PDF documents
\RequirePackage{xcolor}         % Driver-independent color extensions
\RequirePackage{tikz}           % Create PostScript and PDF graphics
\RequirePackage{xspace}         % Define commands that appear not to eat spaces
\RequirePackage{geometry}       % Customize document dimensions
\RequirePackage{titlesec}       % Select alternative section titles
\RequirePackage{titletoc}       % Alternative headings for toc
\RequirePackage{fancyhdr}       % Control of page headers and footers
\RequirePackage{enumitem}       % Control layout of itemize, enumerate, description
\RequirePackage{csquotes}       % for quotes in correct language for bibilatex
\RequirePackage{emptypage}      % Remove header and footer on empty pages
\RequirePackage[style=ieee]{biblatex}    % Bibiography
\RequirePackage{xurl}           % So that url are kept in the document
\RequirePackage[pdfusetitle,hidelinks]{hyperref}    % Extensive support for hypertext
\RequirePackage[noabbrev]{cleveref}                 % Intelligent cross-referencing
\RequirePackage{pdflscape}
\RequirePackage{array}          % new array definition
\RequirePackage{docmute}        % enables to include document
\RequirePackage{arydshln}       % aditionnal line for array (dashed lines)
\RequirePackage{titlesec}
\RequirePackage{hhline}
\RequirePackage{etoolbox}
\setcounter{secnumdepth}{4} 
\RequirePackage[T1]{fontenc}    % Select T1 font encoding
\RequirePackage[scaled]{helvet} % get Helvetica like font
\RequirePackage[helvet]{sfmath}
\RequirePackage{parskip}

%% Customised definition and commands ==========================================
% Emptypage ....................................................................
\def\emptypage{
    \hbox{}
    \thispagestyle{empty}
    \newpage
}
% Array colum type .............................................................
\newcolumntype{x}{>{\centering\arraybackslash\hspace{0pt}}m{4.5mm}}

% Reference with section in french .............................................
\addto\extrasfrench{
    \renewcommand{\sectionautorefname}{Section}
    \let\subsectionautorefname\sectionautorefname
    \let\subsubsectionautorefname\sectionautorefname
}
% Reference with section in british ............................................
\addto\extrasbritish{
    \renewcommand{\sectionautorefname}{Section}
    \let\subsectionautorefname\sectionautorefname
    \let\subsubsectionautorefname\sectionautorefname
}
% Part bookmark level ..........................................................
\def\toclevel@part{1}

% Conditionnal writing from document language...................................
\ExplSyntaxOn

\NewExpandableDocumentCommand{\langcase}{O{}m}
 {
  \str_case_e:nnF { \languagename } { #2 } { #1 }
 }

\ExplSyntaxOff

%% Set Paper format and margin =================================================
\geometry{a4paper,left=2.5cm,right=2.5cm,top=2.5cm,bottom=2.5cm,footskip=1cm,headsep=.5cm}

%% Set indent at strat of paragrph ---------------------------------------------
\setlength{\parindent}{0pt}

%% Define Customised Colors ----------------------------------------------------
\definecolor{myBlue}{HTML}{0076B3}
\definecolor{myGreen}{HTML}{00965E}
\definecolor{myYellow}{HTML}{F5C400}
\definecolor{myRed}{HTML}{C32823}
\definecolor{myGray}{HTML}{413D3A}
\definecolor{myLightGray}{HTML}{ACA39B}
\definecolor{myPurple}{HTML}{6E298D}

%% Setting up the fonts --------------------------------------------------------
\renewcommand{\familydefault}{\sfdefault}  % change main font
%\renewcommand{\rmdefault}{\sfdefault} % change math font

\newcommand*{\titlestyle}{\fontfamily{phv}\selectfont}%\newfontfamily{\titlestyle}{Arial}
\newcommand*{\largetitlestyle}{\fontfamily{phv}\selectfont}%\newfontfamily{\largetitlestyle}{Arial}
\newcommand*{\subjectstyle}{\fontfamily{phv}\selectfont}%\newfontfamily{\subjectstyle}{Arial}

%% Formatting the titles and table of contents =================================
%% Format the part titles and spacing ..........................................
\titleformat{\part}[display]
    {\flushleft\selectfont\largetitlestyle\LARGE\bfseries}
    {\partname \thepart} 
    {-5pt}
    {\titlestyle\Huge}

%% Format the chapter titles and spacing .......................................
\titleformat{\chapter}[hang]
    {\flushleft}
    {\Huge\selectfont\largetitlestyle\thechapter\bfseries}
    {0pt}
    {\Huge\titlestyle}
\titlespacing*{\chapter}{0pt}{0pt}{2\baselineskip}

%% Format the section titles and spacing .......................................
\titleformat{\section}
    {\LARGE\titlestyle\bfseries}
    {\thesection.} 
    {5pt}
    {}%[{\titlerule[2pt]}]
\titlespacing*{\section}{0pt}{2ex plus 1ex minus .2ex}{5pt plus .2ex}

%% Format the subsections titles and spacing ...................................
\titleformat{\subsection}
    {\Large\titlestyle\bfseries}
    {\thesubsection.}
    {5pt}
    {}
\titlespacing*{\subsection}{0pt}{2ex plus 1ex minus .2ex}{5pt plus .2ex}
%\baselineskip 
%% Format the subsubsections titles and spacing ................................
\titleformat{\subsubsection}
    {\large\titlestyle\bfseries}
    {\thesubsubsection. }
    {0pt}
    {}
\titlespacing*{\subsubsection}{0pt}{2ex plus 1ex minus .2ex}{5pt plus .2ex}

%% Format the paraghaph title and spacing ......................................
\titleformat{\paragraph}
    {\itshape\normalsize\bfseries}
    {\theparagraph.}
    {5pt}
    {}
\titlespacing*{\paragraph}{0pt}{2ex plus 1ex minus .2ex}{5pt plus .2ex}

%% Format the subparaghaph title and spacing ...................................
% Uncomment to get title style, keep commented for classic subparagraph
%\titleformat{\subparagraph}
%    {\itshape\titlestyle\normalsize\bfseries}
%    {}
%    {5pt}
%    {}
%\titlespacing*{\subparagraph}{0pt}{2ex plus 1ex minus .2ex}{5pt plus .2ex}

%% Reduce the vertical white space between chapters in the table of contents ...
\dottedcontents{chapter}[1.5em]{\vspace{0.5\baselineskip}\bfseries}{1.5em}{0pt}
\dottedcontents{part}[1.5em]{\vspace{0.5\baselineskip}\bfseries}{1.5em}{0pt}

%% formatting TOC, List of table,list of figure,etc. ...........................
\addto\captionsfrench{
    \renewcommand{\contentsname}
    {\titlestyle\Huge Table des matières}
}
\addto\captionsfrench{
    \renewcommand{\listfigurename}
    {\titlestyle\Huge Liste des figures}
}
\addto\captionsfrench{
    \renewcommand{\listtablename}
    {\titlestyle\Huge Liste des tableaux}
}
\addto\captionsfrench{
    \renewcommand{\lstlistlistingname}
    {\titlestyle\Huge Liste des codes}
}
\addto\captionsbritish{
    \renewcommand{\contentsname}
    {\titlestyle\Huge Contents}
}
\addto\captionsbritish{
    \renewcommand{\listfigurename}
    {\titlestyle\Huge List of figures}
}
\addto\captionsbritish{
    \renewcommand{\listtablename}
    {\titlestyle\Huge List of tables}
}
\addto\captionsbritish{
    \renewcommand{\lstlistlistingname}
    {\titlestyle\Huge List of codes}
}
%% Formatting the header and footer ============================================
%% Format the header and footer of 'intro' pages, aka toc, tof, lot,ect. -------
\fancypagestyle{Intro}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{0pt}
  \renewcommand{\headrulewidth}{1pt}
  \fancyhead[L]{\titlestyle\bfseries\@TopLeft}
  \fancyhead[R]{\titlestyle\bfseries\@TopRight}
  %\fancyhead[C]{\titlestyle\bfseries\@subtitle}
  \fancyfoot[C]{\thepage}
  \titleformat{\section}
    {\LARGE\titlestyle\bfseries}
    {\thesection.}
    {5pt}
    {}
 \titlespacing*{\section}{0pt}{\baselineskip}{0pt}
 \pagenumbering{Roman}
}

%% Format the header and footer of 'main' pages --------------------------------
\fancypagestyle{Main}{%
  \fancyhf{}
  \renewcommand{\headrulewidth}{1pt}
  \fancyhead[L]{\titlestyle\bfseries\@TopLeft}
  \fancyhead[R]{\titlestyle\bfseries\@TopRight}
  \fancyfoot[L]{\titlestyle\bfseries\@BottomLeft}
  \fancyfoot[R]{\titlestyle\bfseries\@BottomRight}
  \titleformat{\section}
    {\LARGE\titlestyle\bfseries}
    {\thesection.}
    {5pt}
    {}[{\titlerule[0pt]}]
  \titlespacing*{\section}{0pt}{\baselineskip}{5pt}
  \pagenumbering{arabic} % set arabic number
  \setcounter{table}{0} % set table counter to 0 first table will be 1
}

%% Format the header and footer of 'appendix' pages ----------------------------
\fancypagestyle{apdx}{%
  \appendix
  \fancyhf{}
  \renewcommand{\headrulewidth}{1pt}
  \pretocmd{\section}{\clearpage\setcounter{page}{1}}{}{} % Réinitialiser la numérotation des pages à chaque nouvelle section
\renewcommand{\thepage}{\thesection-\arabic{page}}% Page numbering style
  \fancyhead[L]{\titlestyle\bfseries\@TopLeft}
  \fancyhead[R]{\titlestyle\bfseries\@TopRight}
  \fancyfoot[L]{\titlestyle\bfseries\@BottomLeft}
  \fancyfoot[R]{\titlestyle\bfseries\@BottomRight}
  \titleformat{\section}
    {\LARGE\titlestyle\bfseries}
    {\thesection.}
    {5pt}
    {}[{\titlerule[0pt]}]
\titlespacing*{\section}{0pt}{\baselineskip}{5pt}
}

%% Sapcing ---------------------------------------------------------------------
\setlength{\belowcaptionskip}{-0.75em}
\setlength{\headheight}{13.59999pt}

%% Setting up listings (code) --------------------------------------------------
\RequirePackage{listings} % Typeset source code listings
\lstset{
  basicstyle=\ttfamily\footnotesize,  % Style of the font that is used for the code
  backgroundcolor=\color{gray!10},    % Background color
  keywordstyle=\color{red!75!black},  % Keyword style
  stringstyle=\color{green!40!black}, % String style
  commentstyle=\color{blue!30!black}, % Comment style
  numbers=left,                       % Add line numbers on the left side
  numbersep=5pt,                      % Decrease distance between line numbers and code
  numberstyle=\tiny,                  % Line number style
  breaklines=true,                    % Line break automatically
}

% Code -------------------------------------------------------------------------
\renewcommand{\lstlistingname}{Code} % change listing to code in caption
% https://en.wikibooks.org/wiki/LaTeX/Source_Code_Listings
\definecolor{codegreen}{HTML}{00965E}
\definecolor{codegray}{HTML}{413D3A}
\definecolor{codepurple}{HTML}{0076B3}
\definecolor{codered}{HTML}{C32823}
\definecolor{backcolour}{HTML}{ACA39B}
\lstdefinestyle{mystyle}{
%    backgroundcolor=\color{backcolour},    % choose the background color; you must add \usepackage{color} or \usepackage{xcolor}; should come as last argument
    basicstyle=\ttfamily\lst@ifdisplaystyle\scriptsize\fi,     % the size of the fonts that are used for the code
    breakatwhitespace=false,         % sets if automatic breaks should only happen at whitespace
    breaklines=true,                 % sets automatic line breaking
    captionpos=b,                    % sets the caption-position to bottom
    commentstyle=\color{codegreen},  % comment style
    deletekeywords={...},            % if you want to delete keywords from the given language
    extendedchars=true,              % lets you use non-ASCII characters; for 8-bits encodings only, does not work with UTF-8
    firstnumber=1,                   % start line enumeration with line 1
    frame=tb,                        % adds a frame around the code
    xleftmargin=2em,
    xrightmargin=0.5em,
    framexleftmargin=1.5em,
    keepspaces=true,                 % keeps spaces in text, useful for keeping indentation of code (possibly needs columns=flexible)
    keywordstyle=\color{codered},    % keyword style
    morekeywords={*,...},            % if you want to add more keywords to the set
    numbers=left,                    % where to put the line-numbers; possible values are (none, left, right)
    numbersep=5pt,                   % how far the line-numbers are from the code
%    numberstyle=\tiny\color{codegray},   % the style that is used for the line-numbers
    rulecolor=\color{black},         % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. comments (green here))
%    identifierstyle=\color{blue},   
    showspaces=false,                % show spaces everywhere adding particular underscores; it overrides 'showstringspaces'
    showstringspaces=false,          % underline spaces within strings only
    showtabs=false,                  % show tabs within strings adding particular underscores
    stepnumber=1 ,                   % the step between two line-numbers. If it's 1, each line will be numbered
    stringstyle=\color{codepurple},  % string literal style
    tabsize=2,                       % sets default tabsize to 2 spaces
    caption=\lstname,                % show the filename of files included with \lstinputlisting; also try caption instead of title
    %literate={\$}{{\textcolor{blue}{\$}}}1,
    %mathescape=false
}
\lstset{style=mystyle}
\lstset{literate=
  {á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
  {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
  {à}{{\`a}}1 {è}{{\`e}}1 {ì}{{\`i}}1 {ò}{{\`o}}1 {ù}{{\`u}}1
  {À}{{\`A}}1 {È}{{\'E}}1 {Ì}{{\`I}}1 {Ò}{{\`O}}1 {Ù}{{\`U}}1
  {ä}{{\"a}}1 {ë}{{\"e}}1 {ï}{{\"i}}1 {ö}{{\"o}}1 {ü}{{\"u}}1
  {Ä}{{\"A}}1 {Ë}{{\"E}}1 {Ï}{{\"I}}1 {Ö}{{\"O}}1 {Ü}{{\"U}}1
  {â}{{\^a}}1 {ê}{{\^e}}1 {î}{{\^i}}1 {ô}{{\^o}}1 {û}{{\^u}}1
  {Â}{{\^A}}1 {Ê}{{\^E}}1 {Î}{{\^I}}1 {Ô}{{\^O}}1 {Û}{{\^U}}1
  {ã}{{\~a}}1 {ẽ}{{\~e}}1 {ĩ}{{\~i}}1 {õ}{{\~o}}1 {ũ}{{\~u}}1
  {Ã}{{\~A}}1 {Ẽ}{{\~E}}1 {Ĩ}{{\~I}}1 {Õ}{{\~O}}1 {Ũ}{{\~U}}1
  {œ}{{\oe}}1 {Œ}{{\OE}}1 {æ}{{\ae}}1 {Æ}{{\AE}}1 {ß}{{\ss}}1
  {ű}{{\H{u}}}1 {Ű}{{\H{U}}}1 {ő}{{\H{o}}}1 {Ő}{{\H{O}}}1
  {ç}{{\c c}}1 {Ç}{{\c C}}1 {ø}{{\o}}1 {å}{{\r a}}1 {Å}{{\r A}}1
  {€}{{\euro}}1 {£}{{\pounds}}1 {«}{{\guillemotleft}}1
  {»}{{\guillemotright}}1 {ñ}{{\~n}}1 {Ñ}{{\~N}}1 {¿}{{?`}}1 {¡}{{!`}}1 {°}{{\textdegree}}1
}

%% MAKING TITLE PAGE -----------------------------------------------------------
\renewcommand*{\maketitle}{
    %% Use the Tikz library positioning and clear the page header and footer
    \usetikzlibrary{positioning}
    \thispagestyle{empty}

    %% Construct the cover page with Tikz
    \begin{tikzpicture}[overlay,remember picture]

    %% Add the logo in the top left ............................................
        \node[below right=10mm] at (current page.north west) {%
            \includegraphics[width=0.7\linewidth]{layout/logo/long_logo.pdf}};

    %% Add the banner with the title, subtitle, subject and author(s) ..........
        \node[name=title, below=3.5cm,fill=myGray,minimum width={\paperwidth},inner ysep=25pt,opacity=1,text opacity=1] at (current page.north) {%
            \begin{minipage}{0.9\paperwidth}
                %% Format and add the title
                \color{myBlue}\raggedright\bfseries\largetitlestyle\fontsize{36}{36}\selectfont%
                \@title \\[0.5ex]
                %% Format and add (optional) subtitle and subject
                \color{white}\titlestyle\bfseries\fontsize{24}{24}\selectfont%
                {\@subtitle \\[1ex]}%
                \color{white}\titlestyle\bfseries\fontsize{18}{18}\selectfont%
                \ifdefvoid{\@subject}{}{\@subject \\[1ex]}
                %% Format and add author or table of authors
                \largetitlestyle\fontsize{24}{24}\selectfont%
                {\,\\[1ex] \@author}
            \end{minipage}};
    %% Add title picture .......................................................
        \node[below=\@DisFromTitleToPic] at (title.south) {
            \includegraphics[height=\@TitlePicHight]{\@TitlePic}};
            
    %% Array with info .........................................................
        \node[above right=50mm and 25pt] at (current page.south west) {%
            \begin{tabular}{ll}
                \fontsize{14}{14}\titlestyle\bfseries \langcase[Supervisor]{{british}{Supervisor}{french}{Superviseur}}: &\fontsize{14}{14}\subjectstyle \@Responsable \\
                \ifdefvoid{\@Partenaire}{}{\fontsize{14}{14}\titlestyle\bfseries \langcase[Partner]{{british}{Partner}{french}{Partenaire}}: &\fontsize{14}{14}\subjectstyle \@Partenaire \\}
                \fontsize{14}{14}\titlestyle\bfseries \langcase[Project duration]{{british}{Project duration}{french}{Durée du projet}}: &\fontsize{14}{14}\subjectstyle \@dateDebut\ \textendash\ \@dateFin \\
                \fontsize{14}{14}\titlestyle\bfseries \langcase[School]{{british}{School}{french}{Filière}}: &\fontsize{14}{14}\subjectstyle\@filiere\\
                \ifdefvoid{\@Version}{}{\fontsize{14}{14}\titlestyle\bfseries \langcase[Version]{{british}{Version}{french}{Version}}: &\fontsize{14}{14}\subjectstyle \@Version\\}
            \end{tabular}};

    %% Botomm line .............................................................
        \draw[white,bottom color=myLightGray,top color=white]([xshift=-5.7cm,yshift=5.49mm]current page.south east) rectangle ( [xshift=-5.5cm,yshift=20.5mm]current page.south east);
        
        \draw[myLightGray,bottom color=myLightGray,top color=myLightGray]([yshift=5.5mm]current page.south east) rectangle (current page.south west);
        
        \draw[myBlue,bottom color=myBlue,top color=myBlue]([xshift=-5.5cm,yshift=0mm]current page.south east) rectangle ( [xshift=0cm,yshift=5.5mm]current page.south east);
        
        %% Add the logo in the bottom right
        \node[above left=10mm] at (current page.south east) {%
            \includegraphics[width=4cm]{layout/logo/short_bottom_logo.pdf}};
        %% Add the text in the bottom left
        \node[above right=10mm] at (current page.south west) {%
            \begin{tabular}{l|l|l|l}
                \subjectstyle HEIA-FR & \subjectstyle Pérolles 80 & \subjectstyle CH-1700 Fribourg & \href{www.heia-fr.ch}{\subjectstyle{www.heia-fr.ch}}
            \end{tabular}};
        \end{tikzpicture}
    \newpage
    \,\vspace{\fill}\\
    \begin{center}%\centering
    \ifdefvoid{\@copyrightNotice}{}{\footnotesize \@copyrightNotice\\}
    \footnotesize The HES-SO logo is the exclusive and total property of the HES-SO.\\
    \footnotesize The HEIA-FR logo is the exclusive and total property of the HEIA-FR.\\
    \end{center}
    \emptypage
}